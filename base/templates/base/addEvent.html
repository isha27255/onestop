<HTML>
    <head>
        <meta charset="utf-8">
        <title><OneStop</title>
    </head>
	<body>
		<form class="field_wrapper" id="eventForm" method="POST">
			{% csrf_token %}
		    <div>
		    	<label>Field name</label>
		        <input type="text" name="field_name[]" value=""/>
		        <label>Field value</label>
		        <input type="text" name="field_value[]" value=""/>
		        <br>
		        <a href="javascript:void(0);" class="add_button" title="Add field">Add</a>
		    </div>
      <input type="submit" /><br>
		</form>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	    <script>// https://github.com/HasanQQ/formToJson.git
			$.fn.formToJson=function(){form=$(this);var formArray=form.serializeArray(),jsonOutput={};return $.each(formArray,(function(i,element){var elemNameSplit=element.name.split("["),elemObjName="jsonOutput";$.each(elemNameSplit,(function(nameKey,value){nameKey!=elemNameSplit.length-1?(elemObjName="]"==value.slice(value.length-1)?"]"===value?elemObjName+"["+Object.keys(eval(elemObjName)).length+"]":elemObjName+"["+value:elemObjName+"."+value,void 0===eval(elemObjName)&&eval(elemObjName+" = {};")):"]"==value.slice(value.length-1)?"]"===value?eval(elemObjName+"["+Object.keys(eval(elemObjName)).length+"] = '"+element.value.replace("'","\\'")+"';"):eval(elemObjName+"["+value+" = '"+element.value.replace("'","\\'")+"';"):eval(elemObjName+"."+value+" = '"+element.value.replace("'","\\'")+"';")}))})),jsonOutput};
		</script>


	    <script type="text/javascript">
			$(document).ready(function(){
			    var addButton = $('.add_button');
			    var wrapper = $('.field_wrapper');
			    var fieldHTML = '<label>Field name</label><input type="text" name="field_name[]" value=""/><label>Field value</label><input type="text" name="field_value[]" value=""/><br>'; //New input field html

			    $(addButton).click(function(){
			            $(wrapper).append(fieldHTML);
			    });

			});

		    $("#eventForm").submit(function(e) {
		    	var json_obj=$(this).formToJson()
		        var json_send = {}
		        var count = Object.keys(json_obj).length;
		      	for(var i=0; i<count; i++){
		        	json_send[json_obj.field_name[i]] = json_obj.field_value[i]
		        }

		        $.ajax({
			        type:'POST',
			        url:'{% url "addEvent" %}',
			        data:{
			            json_sent:JSON.stringify(json_send),
			            csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
			            action: 'post',
			        },
                    success: function (data) {
                        console.log("SUCC");
                        window.location = '{% url "index" %}'
                    },
                    error: function(data) {
                        console.log("ERR");
                    }
			    });
		        return false;
			});
		</script>
	</body>
</HTML>